(window.webpackJsonp=window.webpackJsonp||[]).push([[27],{291:function(t,s,a){"use strict";a.r(s);var e=a(38),n=Object(e.a)({},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"kvc-原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#kvc-原理","aria-hidden":"true"}},[t._v("#")]),t._v(" KVC 原理")]),t._v(" "),a("h3",{attrs:{id:"_0x0-valueforkey"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_0x0-valueforkey","aria-hidden":"true"}},[t._v("#")]),t._v(" "),a("span",{staticStyle:{"font-family":"auto"}},[t._v("0x0. valueForKey:")])]),t._v(" "),a("p",[t._v("当我们调用"),a("code",[t._v("valueForKey:")]),t._v("时，内部会创建一个 NSKeyValueMethodGetter 对象，接着调用"),a("code",[t._v("_NSGetUsingKeyValueGetter(self, getter)")]),t._v("方法。")]),t._v(" "),a("p",[t._v("伪代码如下：")]),t._v(" "),a("div",{staticClass:"language-objectivec line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-objectivec"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("valueForKey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("key "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    Class cls "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("object_getClass")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("self")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("OSSpinLockLock")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("NSKVOLock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    NSKeyValueMethodGetter "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("getter "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("NSObject _createValueGetterWithContainerClassID"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("cls key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("OSSpinLockUnlock")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("NSKVOLock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("_NSGetUsingKeyValueGetter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("self")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" getter"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br")])]),a("p",[t._v("那么是如何根据 key 找到对应的 value 呢？\n结合官方文档和代码实践，绘制了具体查找流程，如下图：\n"),a("img",{attrs:{src:"/resources/kvc.png",alt:"kvc"}})]),t._v(" "),a("h3",{attrs:{id:"_0x1-setvalue-forkey"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_0x1-setvalue-forkey","aria-hidden":"true"}},[t._v("#")]),t._v(" "),a("span",{staticStyle:{"font-family":"auto"}},[t._v("0x1. setValue:forKey:")])]),t._v(" "),a("p",[t._v("当调用"),a("code",[t._v("setValue:forKey:")]),t._v("时，内部会创建一个 NSKeyValueMethodSetter 对象，接着调用"),a("code",[t._v("_NSSetUsingKeyValueSetter(self, setter, value)")]),t._v("方法。")]),t._v(" "),a("p",[t._v("伪代码如下：")]),t._v(" "),a("div",{staticClass:"language-objectivec line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-objectivec"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("setValue"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("value forKey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("NSString "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("key "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    Class cls "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("object_getClass")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("self")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("OSSpinLockLock")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("NSKVOLock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    NSKeyValueMethodSetter "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("setter "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("NSObject _createValueSetterWithContainerClassID"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("cls key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("OSSpinLockUnlock")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("NSKVOLock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("_NSSetUsingKeyValueSetter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("self")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" setter"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" value"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br")])]),a("p",[t._v("流程如下：")]),t._v(" "),a("ol",[a("li",[t._v("按顺序查找名字为"),a("code",[t._v("setKey:")]),t._v("或者"),a("code",[t._v("_setKey:")]),t._v("方法，如果找到，则进行调用并将"),a("code",[t._v("value")]),t._v("作为入参；")])]),t._v(" "),a("div",{staticClass:"tip custom-block"},[a("p",[t._v("如果"),a("code",[t._v("key")]),t._v("为属性名且不以下划线开头，则只会查找"),a("code",[t._v("setKey:")]),t._v("方法；")]),t._v(" "),a("p",[t._v("如果"),a("code",[t._v("key")]),t._v("为实例变量或者以下划线开头的属性名，则会先找"),a("code",[t._v("setKey:")]),t._v("方法，没找到，再找"),a("code",[t._v("_setKey:")]),t._v("方法")])]),t._v(" "),a("ol",{attrs:{start:"2"}},[a("li",[t._v("若步骤1未能处理，则进行当前步骤。会查看"),a("code",[t._v("accessInstanceVariablesDirectly")]),t._v("方法返回值，若为 YES，则会按顺序查找以下名字实例变量："),a("code",[t._v("_key")]),t._v("、"),a("code",[t._v("_isKey")]),t._v("、"),a("code",[t._v("key")]),t._v("、"),a("code",[t._v("isKey")]),t._v("；若返回NO或者没找到这几个实例变量，则会抛出"),a("code",[t._v("setValue:forUndefinedKey:")]),t._v("异常。")])]),t._v(" "),a("hr"),t._v(" "),a("p",[t._v("参考链接：\n"),a("a",{attrs:{href:"https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/KeyValueCoding/SearchImplementation.html#//apple_ref/doc/uid/20000955-CJBBBFFA",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/KeyValueCoding/"),a("OutboundLink")],1)])])},[],!1,null,null,null);s.default=n.exports}}]);