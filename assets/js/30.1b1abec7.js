(window.webpackJsonp=window.webpackJsonp||[]).push([[30],{294:function(t,s,a){"use strict";a.r(s);var n=a(38),r=Object(n.a)({},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"runloop-探索"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#runloop-探索","aria-hidden":"true"}},[t._v("#")]),t._v(" RunLoop 探索")]),t._v(" "),a("h3",{attrs:{id:"_0x1-疑问一：主线程是如何接受到-touch-事件的？"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_0x1-疑问一：主线程是如何接受到-touch-事件的？","aria-hidden":"true"}},[t._v("#")]),t._v(" 0x1. 疑问一：主线程是如何接受到 touch 事件的？")]),t._v(" "),a("h4",{attrs:{id:"一、推测"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、推测","aria-hidden":"true"}},[t._v("#")]),t._v(" 一、推测")]),t._v(" "),a("p",[t._v("UI线程捕获 touch 事件，通知主线程，由主线程进行处理......")]),t._v(" "),a("p",[t._v("那么这一过程是否果真如此，还需要动手去验证。")]),t._v(" "),a("h4",{attrs:{id:"二、验证"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、验证","aria-hidden":"true"}},[t._v("#")]),t._v(" 二、验证")]),t._v(" "),a("p",[t._v("在 touchBegin 中打个断点，手指触摸屏幕时，通过调用栈，能看到 runloop 一些东西。所以，加了个符号断点"),a("code",[t._v("__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE1_PERFORM_FUNCTION__")]),t._v("。")]),t._v(" "),a("p",[t._v("再次触摸时，发现断在了 UI 线程。如图：")]),t._v(" "),a("p",[a("img",{attrs:{src:"/resources/runloop_uikit_thread.png",alt:""}})]),t._v(" "),a("p",[t._v("由此看出 UI 线程这个 source1 事件还是比较可疑。")]),t._v(" "),a("div",{staticClass:"language-objectivec line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-objectivec"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE1_PERFORM_FUNCTION__")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("perform"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" CFIndex size"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" CFAllocatorRef allocator"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("info"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" mach_msg_header_t "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" CFIndex size"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" mach_msg_header_t "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("reply"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("info"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("perform"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("reply "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("perform")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" size"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" kCFAllocatorSystemDefault"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" info"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("asm")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("__volatile__")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// thwart tail-call optimization")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br")])]),a("p",[t._v("查看源码发现，该函数内部只是调用了"),a("code",[t._v("perform")]),t._v("函数，所以在调用"),a("code",[t._v("perform")]),t._v("处加个断点，如图：")]),t._v(" "),a("p",[a("img",{attrs:{src:"/resources/runloop_uikit_thread_callq.png",alt:""}})]),t._v(" "),a("p",[t._v("由于"),a("code",[t._v("__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE1_PERFORM_FUNCTION__")]),t._v("内部只有一处函数调用，所以很容易确定"),a("code",[t._v("callq *%rax")]),t._v("指令就是对"),a("code",[t._v("perform")]),t._v("函数的调用。")]),t._v(" "),a("p",[t._v("同时在"),a("code",[t._v("__CFRunLoopRun")]),t._v("函数中的 "),a("code",[t._v("__CFRunLoopServiceMachPort")]),t._v("调用处的后一条指令添加断点。")]),t._v(" "),a("div",{staticClass:"tip custom-block"},[a("p",[t._v("因为此时主线程 runloop 处于休眠状态，若被唤醒，必然从"),a("code",[t._v("__CFRunLoopServiceMachPort")]),t._v("的下一条指令开始执行。")])]),t._v(" "),a("p",[t._v("当 UI 线程执行到"),a("code",[t._v("call *%rax")]),t._v("时，主线程还处于休眠状态，当该指令执行完，主线程 runloop 会被唤醒，断点生效。")]),t._v(" "),a("p",[t._v("由源码可知，runloop 由以下这几种方式被唤醒：timer、source1、GCD 以及 wakeUpPort（对源码做了精简，只保留核心部分）")]),t._v(" "),a("div",{staticClass:"language-objectivec line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-objectivec"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// waitSet包含：source1_port, timer_port, dispatch_port, wakeup_port")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("__CFRunLoopServiceMachPort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("waitSet"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("msg_buffer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("livePort"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" poll "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" TIMEOUT_INFINITY"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("voucherState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("voucherCopy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 通知观察者 已唤醒")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("poll "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rlm"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("_observerMask "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" kCFRunLoopAfterWaiting"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("__CFRunLoopDoObservers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" rlm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" kCFRunLoopAfterWaiting"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    \nhandle_msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" \n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("MACH_PORT_NULL "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" livePort"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// handle nothing")]),t._v("\n            \n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("livePort "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" rl"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("_wakeUpPort"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// do nothing on Mac OS")]),t._v("\n            \n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rlm"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("_timerPort "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" MACH_PORT_NULL "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" livePort "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" rlm"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("_timerPort"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("__CFRunLoopDoTimers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" rlm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mach_absolute_time")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("__CFArmNextTimerInMode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rlm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" rl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n            \n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("livePort "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" dispatchPort"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("__CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            \n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        CFRunLoopSourceRef rls "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("__CFRunLoopModeFindSourceForMachPort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" rlm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" livePort"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rls"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            mach_msg_header_t "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("reply "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("__CFRunLoopDoSource1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" rlm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" rls"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" msg"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("msgh_size"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("reply"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" reply"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mach_msg")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("reply"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" MACH_SEND_MSG"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" reply"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("msgh_size"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" MACH_PORT_NULL"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" MACH_PORT_NULL"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br"),a("span",{staticClass:"line-number"},[t._v("32")]),a("br"),a("span",{staticClass:"line-number"},[t._v("33")]),a("br")])]),a("p",[t._v("那么接下来就要确认下主线程的 runloop 究竟是被哪一种方式唤醒的。")]),t._v(" "),a("p",[t._v("首先比较容易排除的是 timer 和 GCD，那么就着重分析下是 source1 还是 wakeUpPort。")]),t._v(" "),a("p",[t._v("通过上述源码可以看到，唤醒 runloop 的端口（liveport）判断，是在"),a("code",[t._v("__CFRunLoopDoObservers")]),t._v("之后，所以，在这之后寻找可疑汇编指令，设置断点进行验证。")]),t._v(" "),a("p",[a("img",{attrs:{src:"/resources/runloop_liveport.png",alt:""}})]),t._v(" "),a("p",[a("img",{attrs:{src:"/resources/runloop_last.png",alt:""}})]),t._v(" "),a("p",[t._v("通过断点调试发现，runloop 的地址存在"),a("code",[t._v("%rbx")]),t._v("寄存器中，wakeUpPort 为 0x2103，而"),a("code",[t._v("0x50(%rbx)")]),t._v("这条汇编指令的作用便是取出 runloop 中的 wakeUpPort 成员变量。那么"),a("code",[t._v("%r13")]),t._v("中的值便是 livePort，也是 0x2103。由此可见，主线程 runloop 被唤醒，是 UI 线程给它的 wakeUpPort 端口发的消息，而并非 source1。")]),t._v(" "),a("p",[t._v("汇编指令"),a("code",[t._v("cmpl 0x50(%rbx), %r13d")]),t._v("对应的源码为：")]),t._v(" "),a("div",{staticClass:"language-objectivec line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-objectivec"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// %r13: livePort    rl->_wakeUpPort: 0x50(%rbx)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("livePort "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" rl"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("_wakeUpPort"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" \n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// do nothing on Mac OS     ")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 这里对应的汇编指令为 nop   ")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br")])]),a("p",[t._v("进而可以看出上一条汇编指令"),a("code",[t._v("testq %r13, %r13")]),t._v("对应的源码为：")]),t._v(" "),a("div",{staticClass:"language-objectivec line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-objectivec"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("MACH_PORT_NULL "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" livePort"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// MACH_PORT_NULL 宏展开为 0")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("CFRUNLOOP_WAKEUP_FOR_NOTHING")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// handle nothing")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 这里对应的汇编指令为 nop   ")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" \n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br")])]),a("div",{staticClass:"tip custom-block"},[a("p",[a("code",[t._v("cmpl 0x50(%rbx), %r13d")]),t._v("是从 runloop 的内存地址偏移80个字节处取值，并与"),a("code",[t._v("%r13")]),t._v("做比较。")]),t._v(" "),a("p",[a("code",[t._v("testq %r13, %r13")]),t._v("是判断"),a("code",[t._v("%r13")]),t._v("中的值是否为零，具体可"),a("router-link",{attrs:{to:"/assembly/assemblyinstructions.html#test"}},[t._v("参考这里")]),t._v("。")],1)]),t._v(" "),a("h4",{attrs:{id:"三、结论"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、结论","aria-hidden":"true"}},[t._v("#")]),t._v(" 三、结论")]),t._v(" "),a("p",[t._v("由上可知，唤醒 runloop 的端口为 wakeUpPort。整个流程大概是：")]),t._v(" "),a("ul",[a("li",[t._v("系统捕获触摸事件，通过 source1 唤醒 UI 线程；")]),t._v(" "),a("li",[t._v("UI 线程处理 source1 事件，其实是给主线程 runloop 的 wakeUpPort 端口发消息（调用__CFMachPortPerform函数）；")]),t._v(" "),a("li",[t._v("主线程 runloop 唤醒后，开始处理 source0，进而调用 touchBegin 方法。")])]),t._v(" "),a("div",{staticClass:"tip custom-block"},[a("p",[t._v("wakeUpPort 端口的作用，就是用来唤醒 runloop。函数"),a("code",[t._v("CFRunLoopWakeUp")]),t._v("的实现，其实就是向该端口发消息，从而唤醒 runloop 来处理事件。")])])])},[],!1,null,null,null);s.default=r.exports}}]);