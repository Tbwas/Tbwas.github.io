(window.webpackJsonp=window.webpackJsonp||[]).push([[29],{292:function(t,s,n){"use strict";n.r(s);var e=n(38),a=Object(e.a)({},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"ios-事件响应链"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#ios-事件响应链","aria-hidden":"true"}},[t._v("#")]),t._v(" iOS 事件响应链")]),t._v(" "),n("p"),n("div",{staticClass:"table-of-contents"},[n("ul",[n("li",[n("a",{attrs:{href:"#_0x0-简介"}},[t._v("0x0. 简介")])]),n("li",[n("a",{attrs:{href:"#_0x1-查找响应者"}},[t._v("0x1. 查找响应者")]),n("ul",[n("li",[n("a",{attrs:{href:"#_0x1-1-hittest-withevent"}},[t._v("0x1.1. hitTest:withEvent:")])])])]),n("li",[n("a",{attrs:{href:"#_0x2-处理事件"}},[t._v("0x2. 处理事件")])])])]),n("p"),t._v(" "),n("h2",{attrs:{id:"_0x0-简介"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_0x0-简介","aria-hidden":"true"}},[t._v("#")]),t._v(" 0x0. 简介")]),t._v(" "),n("p",[t._v("iOS 中的事件类型有"),n("code",[t._v("Touch event")]),t._v("、"),n("code",[t._v("Press events")]),t._v("、"),n("code",[t._v("Shake-motion events")]),t._v("、"),n("code",[t._v("Remote-control events")]),t._v("，本文暂时只分析最常用的"),n("code",[t._v("Touch event")]),t._v("。")]),t._v(" "),n("p",[t._v("App 使用 responder 对象 (UIResponder实例) 来"),n("strong",[t._v("接收")]),t._v("和"),n("strong",[t._v("处理")]),t._v("事件。常见的子类包括 UIView, UIViewController 和 UIApplication。当 responder 对象接收到原始事件数据后，必须处理事件或将其转发给另一个 responder 对象。")]),t._v(" "),n("p",[t._v("🌴")]),t._v(" "),n("h2",{attrs:{id:"_0x1-查找响应者"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_0x1-查找响应者","aria-hidden":"true"}},[t._v("#")]),t._v(" 0x1. 查找响应者")]),t._v(" "),n("p",[t._v("事件要想被处理，就必须得有个 responder 来响应它。那么一个事件是如何找到它的 responder 的呢？")]),t._v(" "),n("h3",{attrs:{id:"_0x1-1-hittest-withevent"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_0x1-1-hittest-withevent","aria-hidden":"true"}},[t._v("#")]),t._v(" 0x1.1. "),n("code",[t._v("hitTest:withEvent:")])]),t._v(" "),n("p",[t._v("这个方法相信大家一定不陌生，UIKit 便是使用这个方法 (点击测试) 来查找触摸事件的响应者。")]),t._v(" "),n("p",[t._v("该方法内部会调用"),n("code",[t._v("pointInside:withEvent:")]),t._v("方法：")]),t._v(" "),n("ul",[n("li",[t._v("如果"),n("code",[t._v("pointInside:withEvent:")]),t._v("返回 YES，则会遍历当前视图的所有 subview，对每个 subview 依次调用"),n("code",[t._v("hitTest:withEvent:")]),t._v("方法。如果 subview 还有 subview，则以此类推，直到找到包含触摸位置的最前面的视图 (即最后 add 的视图) 为止。")]),t._v(" "),n("li",[t._v("如果"),n("code",[t._v("pointInside:withEvent:")]),t._v("返回 NO，那么"),n("code",[t._v("hitTest:withEvent:")]),t._v("方法会返回 nil，并且当前视图的 subview 也不会被遍历。")])]),t._v(" "),n("p",[t._v("subview 的遍历顺序，是从后往前遍历，即先遍历最后 add 的子视图。当然，并不是所有的 view 都会遍历，如果一个 view 满足下列条件任意一个或多个，将会被忽略。"),n("br"),t._v("1. hidden = YES"),n("br"),t._v("\n2. userInteraction = NO"),n("br"),t._v("\n3. alpha < 0.01")]),t._v(" "),n("p",[t._v("通过断点调试，推测出伪代码如下：")]),t._v(" "),n("div",{staticClass:"language-objectivec line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-objectivec"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" BOOL "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("_UIViewIgnoresTouchEvents")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("UIView "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("view"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("view"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("isUserInteractionEnabled "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" view"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("isHidden "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" view"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("alpha "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.01")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" YES"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" NO"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("UIView "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("hitTest"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("CGPoint"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("point withEvent"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("UIEvent "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("event "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("_UIViewIgnoresTouchEvents")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("self")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" nil"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("self")]),t._v(" pointInside"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("point withEvent"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("event"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" NO"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" nil"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    \n    __block UIView "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("view "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" nil"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("self")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("subviews enumerateObjectsWithOptions"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("NSEnumerationReverse usingBlock"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("^")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__kindof UIView "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" _Nonnull obj"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" NSUInteger idx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" BOOL "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" _Nonnull stop"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        view "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("obj hitTest"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("point withEvent"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("event"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("view"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("stop "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" YES"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" view "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" view "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("self")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br"),n("span",{staticClass:"line-number"},[t._v("22")]),n("br"),n("span",{staticClass:"line-number"},[t._v("23")]),n("br"),n("span",{staticClass:"line-number"},[t._v("24")]),n("br")])]),n("p",[t._v("稍微留意下，会发现虽然 touch 了一次，但是"),n("code",[t._v("hitTest:withEvent:")]),t._v("却调用了两次，关于这个问题，只找到了这么一个"),n("a",{attrs:{href:"https://lists.apple.com/archives/cocoa-dev/2014/Feb/msg00118.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("差不多的解释"),n("OutboundLink")],1),t._v("：")]),t._v(" "),n("blockquote",[n("p",[t._v("Yes, it’s normal. The system may tweak the point being hit tested between the calls. Since hitTest should be a pure function with no side-effects, this should be fine.")])]),t._v(" "),n("p",[t._v("🌴")]),t._v(" "),n("h2",{attrs:{id:"_0x2-处理事件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_0x2-处理事件","aria-hidden":"true"}},[t._v("#")]),t._v(" 0x2. 处理事件")]),t._v(" "),n("p",[t._v("当找到 responder 对象时，会优先判断是否响应手势。如果 responder 上添加了手势，并且手势代理方法"),n("code",[t._v("gestureRecognizer:shouldReceiveTouch:")]),t._v("返回 YES，那么就会直接响应手势。")]),t._v(" "),n("p",[t._v("如果没有手势可以响应，那么就会调用"),n("code",[t._v("touchesBegan:withEvent:")]),t._v("方法。若想自己处理事件，可以重写该方法，重写后，通常不需要调用 super，只需处理事件即可。如果调\b用了"),n("code",[t._v("[super touchesBegan:touches withEvent:event];")]),t._v("，则事件将会沿着响应链转发传递。")]),t._v(" "),n("p",[t._v("比如，我们子类化一个 UIButton，重写了"),n("code",[t._v("touchesBegan:withEvent:")]),t._v("且没有调用 super ，那么当点击 button 时，你会发现添加在 button 上的 action 并不会调用，因为事件默认在"),n("code",[t._v("touchesBegan:withEvent:")]),t._v("中处理了。")]),t._v(" "),n("p",[t._v("从官方文档中，取一张事件响应链的图片：")]),t._v(" "),n("p",[n("img",{attrs:{src:"/resources/chain.png",alt:""}})]),t._v(" "),n("hr"),t._v(" "),n("p",[t._v("参考链接：\n"),n("a",{attrs:{href:"https://developer.apple.com/documentation/uikit/touches_presses_and_gestures/using_responders_and_the_responder_chain_to_handle_events?language=objc#3004381",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://developer.apple.com/documentation/uikit/touches_presses_and_gestures/using_responders_and_the_responder_chain_to_handle_events"),n("OutboundLink")],1)])])},[],!1,null,null,null);s.default=a.exports}}]);