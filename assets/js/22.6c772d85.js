(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{286:function(s,t,a){"use strict";a.r(t);var n=a(38),e=Object(n.a)({},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"编译器指令剖析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#编译器指令剖析","aria-hidden":"true"}},[s._v("#")]),s._v(" 编译器指令剖析")]),s._v(" "),a("h3",{attrs:{id:"前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前言","aria-hidden":"true"}},[s._v("#")]),s._v(" 前言")]),s._v(" "),a("p",[s._v("日常工作中，经常会遇到一些类似于"),a("code",[s._v("__attribute__((xxx))")]),s._v("样式的“代码”，这些“代码”的作用一般都是告诉编译器，在编译阶段需要干点额外事情来达到我们的要求。这里，姑且将这些“代码”称为编译器指令。本文主要记录一些编译器指令的实现原理以及具体用途。")]),s._v(" "),a("h3",{attrs:{id:"正文"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#正文","aria-hidden":"true"}},[s._v("#")]),s._v(" 正文")]),s._v(" "),a("h3",{attrs:{id:"attribute-noreturn"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#attribute-noreturn","aria-hidden":"true"}},[s._v("#")]),s._v(" __ attribute__((noreturn))")]),s._v(" "),a("p",[s._v("告诉编译器，被该指令修饰的函数不会返回，以便编译器可以通过删除那些不会执行的代码来进行优化。")]),s._v(" "),a("p",[s._v("比如下面这段代码👇")]),s._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("__attribute__")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("noreturn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("playing")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// do something")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// code will never be executed")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[a("code",[s._v("while(1)")]),s._v("之后的代码永远不会执行，即该函数不会返回，则可以通过该编译器指令进行优化。")]),s._v(" "),a("p",[s._v("那么问题来了，编译器究竟删除了哪些代码？是如何优化的？")]),s._v(" "),a("p",[s._v("由于没有找到详细介绍的官方资料，所以只好从汇编层面下手。")]),s._v(" "),a("div",{staticClass:"warning custom-block"},[a("p",[s._v("以下使用的汇编指令是 Xcode 模拟器生成，所以格式上和 iOS 真机不太一样。具体可以"),a("router-link",{attrs:{to:"/assembly/assemblybasic.html"}},[s._v("参考这里。")])],1)]),s._v(" "),a("ul",[a("li",[s._v("先来看下不加这条编译指令时，函数编译后的汇编代码：")])]),s._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 源码")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("playing")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// do something")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// code will never be executed")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("div",{staticClass:"language-wasm line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-wasm"}},[a("code",[s._v("; 汇编\nattribute.app`playing:\n    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x104825f80")]),s._v(" <"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("+0")]),s._v(">:  pushq  %rbp            ; 将caller帧指针保存在栈里\n    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x104825f81")]),s._v(" <"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("+1")]),s._v(">:  movq   %rsp, %rbp      ; 将帧指针指向栈顶，准备开始一个新的栈帧\n    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x104825f84")]),s._v(" <"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("+4")]),s._v(">:  jmp    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x104825f89")]),s._v("     ; <"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("+9")]),s._v("> at ViewController.m:"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("35")]),s._v(":"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\n->  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x104825f89")]),s._v(" <"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("+9")]),s._v(">:  jmp    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x104825f8e")]),s._v("     ; <"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("+14")]),s._v("> at ViewController.m:"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("35")]),s._v(":"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x104825f8e")]),s._v(" <"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("+14")]),s._v(">: movb   "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$0x1")]),s._v(", %al\n    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x104825f90")]),s._v(" <"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("+16")]),s._v(">: testb  "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$0x1")]),s._v(", %al\n    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x104825f92")]),s._v(" <"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("+18")]),s._v(">: jne    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x104825f89")]),s._v("     ; <"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("+9")]),s._v("> at ViewController.m:"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("35")]),s._v(":"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x104825f98")]),s._v(" <"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("+24")]),s._v(">: jmp    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x104825f9d")]),s._v("     ; <"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("+29")]),s._v("> at ViewController.m:"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("37")]),s._v(":"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x104825f9d")]),s._v(" <"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("+29")]),s._v(">: popq   %rbp            ; 将caller帧指针从栈里取出\n    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x104825f9e")]),s._v(" <"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("+30")]),s._v(">: retq                   ; 返回\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("div",{staticClass:"tip custom-block"},[a("p",[a("code",[s._v("popq")]),s._v(" 和 "),a("code",[s._v("retq")]),s._v(" 这两条指令配合使用，便可以完成一个子函数的调用返回。"),a("router-link",{attrs:{to:"/assembly/assemblyinstructions.html#ret"}},[s._v("详见这里。")])],1)]),s._v(" "),a("ul",[a("li",[s._v("再看下加上这条编译指令后，函数编译后的汇编代码：")])]),s._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 源码")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("__attribute__")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("noreturn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("playing")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// do something")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// code will never be executed")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("div",{staticClass:"language-wasm line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-wasm"}},[a("code",[s._v("; 汇编\nattribute.app`playing:\n    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x106e72f80")]),s._v(" <"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("+0")]),s._v(">:  pushq  %rbp            ; 将caller帧指针保存在栈里\n    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x106e72f81")]),s._v(" <"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("+1")]),s._v(">:  movq   %rsp, %rbp      ; 将帧指针指向栈顶，准备开始一个新的栈帧\n    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x106e72f84")]),s._v(" <"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("+4")]),s._v(">:  jmp    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x106e72f89")]),s._v("     ; <"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("+9")]),s._v("> at ViewController.m:"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("35")]),s._v(":"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\n->  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x106e72f89")]),s._v(" <"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("+9")]),s._v(">:  jmp    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x106e72f8e")]),s._v("     ; <"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("+14")]),s._v("> at ViewController.m:"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("35")]),s._v(":"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x106e72f8e")]),s._v(" <"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("+14")]),s._v(">: movb   "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$0x1")]),s._v(", %al\n    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x106e72f90")]),s._v(" <"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("+16")]),s._v(">: testb  "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$0x1")]),s._v(", %al\n    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x106e72f92")]),s._v(" <"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("+18")]),s._v(">: jne    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x106e72f89")]),s._v("     ; <"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("+9")]),s._v("> at ViewController.m:"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("35")]),s._v(":"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x106e72f98")]),s._v(" <"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("+24")]),s._v(">: jmp    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x106e72f9d")]),s._v("     ; <"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("+29")]),s._v("> at ViewController.m:"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("37")]),s._v(":"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x106e72f9d")]),s._v(" <"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("+29")]),s._v(">: ud2                    ; 注意这里，是一条中断指令\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("通过对比两次汇编代码，可以看到函数被"),a("code",[s._v("__attribute__((noreturn))")]),s._v("修饰后，尾部的 "),a("code",[s._v("pop")]),s._v(" 和 "),a("code",[s._v("ret")]),s._v(" 两条指令会被优化掉，取而代之的是一条 "),a("router-link",{attrs:{to:"/assembly/assemblyinstructions.html#ud2"}},[s._v("ud2")]),s._v(" 指令。既然函数被标记了"),a("code",[s._v("__attribute__((noreturn))")]),s._v("，就表明程序不会返回；若返回了，便会序执行到 "),a("router-link",{attrs:{to:"/assembly/assemblyinstructions.html#ud2"}},[s._v("ud2")]),s._v(" 这里，引发 "),a("code",[s._v("EXC_BAD_INSTRUCTION")]),s._v("。")],1),s._v(" "),a("p",[s._v("以上，分析的是 C 函数，而对于 Objective-C 中的类方法和实例方法，经过尝试，该编译器指令并不会生效。至于原因，据"),a("a",{attrs:{href:"https://clang.llvm.org/docs/AttributeReference.html#id1",target:"_blank",rel:"noopener noreferrer"}},[s._v("Clang文档"),a("OutboundLink")],1),s._v("中描述，编译器可能会诊断被 "),a("code",[s._v("noreturn")]),s._v(" 修饰的函数，从而能够使函数仍然可以返回给调用方。")]),s._v(" "),a("p",[a("strong",[s._v("参考资料：")])]),s._v(" "),a("p",[a("a",{attrs:{href:"https://clang.llvm.org/docs/AttributeReference.html#id1",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://clang.llvm.org/docs/AttributeReference.html"),a("OutboundLink")],1),s._v(" "),a("a",{attrs:{href:"http://www.keil.com/support/man/docs/armcc/armcc_chr1359124965789.htm",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://www.keil.com/support/man/docs/armcc/armcc_chr1359124965789.htm"),a("OutboundLink")],1)])])},[],!1,null,null,null);t.default=e.exports}}]);